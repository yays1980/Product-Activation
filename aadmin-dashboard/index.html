<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة تحكم نظام التفعيل</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ... الكود كما هو ... */
    </style>
</head>
<body>
    <!-- ... الكود كما هو ... -->
    <script>
        // #####################
        // إصلاحات وملاحظات هامة
        // #####################

        // 1. استخدام "products" بدلاً من "products?" في بعض الأماكن لتجنب undefined.
        // 2. استخدام "users" بدلاً من "users?" في بعض الأماكن لتجنب undefined.
        // 3. إصلاح اختيار الحالة في تعديل المنتج ليكون متوافقاً دائماً (value من نوع string).
        // 4. إصلاح مشكلة نسخ المفاتيح في بعض المتصفحات القديمة (استخدام Clipboard API بدلاً من execCommand).
        // 5. إصلاح حذف الخيارات المكررة في المنتجات (استخدام عنصر option منفصل لكل قائمة).
        // 6. إصلاح إغلاق المودال عند النقر خارج محتوى المودال.
        // 7. إضافة فحص لحماية الدوال من DOM غير موجود.
        // 8. إصلاح مشكلة عديم التعريف في بعض خرائط البيانات.
        // 9. إصلاح خطأ في رسالة التقارير: alert-info يجب أن تكون معرفة في CSS.
        // 10. إصلاح حدث التنقل: إذا كانت الصفحة غير موجودة لا ترمي خطأ.
        // 11. إصلاح بعض أخطاء الواجهة في التوكن والمنتجات.
        // #####################

        let authToken = null;
        let currentAdmin = null;
        const API_BASE_URL = 'http://localhost:5000';

        const loginPage = document.getElementById('loginPage');
        const dashboardPage = document.getElementById('dashboardPage');
        const loginForm = document.getElementById('loginForm');
        const loginMessage = document.getElementById('loginMessage');
        const logoutBtn = document.getElementById('logoutBtn');
        const adminName = document.getElementById('adminName');
        const pageLinks = document.querySelectorAll('.sidebar-menu a');
        const pageContents = document.querySelectorAll('.page-content');

        // تسجيل الدخول
        if (loginForm) {
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            try {
                const response = await fetch(`${API_BASE_URL}/admin/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, password })
                });
                const data = await response.json();
                if (data.success) {
                    authToken = data.token;
                    currentAdmin = data.user;
                    localStorage.setItem('adminToken', authToken);
                    localStorage.setItem('adminData', JSON.stringify(currentAdmin));
                    adminName.textContent = currentAdmin.name || currentAdmin.email;
                    loginPage.classList.add('hidden');
                    dashboardPage.classList.remove('hidden');
                    loadDashboardData();
                    loadProductOptions();
                } else {
                    showMessage(loginMessage, data.message, 'error');
                }
            } catch (error) {
                showMessage(loginMessage, 'خطأ في الاتصال بالخادم', 'error');
                console.error('Login error:', error);
            }
        });
        }

        // تسجيل الخروج
        if (logoutBtn) {
        logoutBtn.addEventListener('click', () => {
            authToken = null;
            currentAdmin = null;
            localStorage.removeItem('adminToken');
            localStorage.removeItem('adminData');
            dashboardPage.classList.add('hidden');
            loginPage.classList.remove('hidden');
            loginForm.reset();
        });
        }

        // التنقل بين الصفحات
        pageLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                pageLinks.forEach(l => l.classList.remove('active'));
                link.classList.add('active');
                pageContents.forEach(content => content.classList.add('hidden'));
                const pageId = link.getAttribute('data-page');
                const pageContent = document.getElementById(`${pageId}Content`);
                if (pageContent) pageContent.classList.remove('hidden');
                if (pageId === 'keys') loadKeys();
                else if (pageId === 'products') loadProducts();
                else if (pageId === 'activations') loadActivations();
                else if (pageId === 'dashboard') loadDashboardData();
                else if (pageId === 'addKey') loadProductOptions();
            });
        });

        async function loadDashboardData() {
            try {
                const statsResponse = await fetch(`${API_BASE_URL}/admin/stats`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                if (statsResponse.ok) {
                    const statsData = await statsResponse.json();
                    if (statsData.success) {
                        document.getElementById('totalActivations').textContent = statsData.stats.total_activations || 0;
                        document.getElementById('usedKeys').textContent = statsData.stats.used_keys || 0;
                        document.getElementById('unusedKeys').textContent = statsData.stats.unused_keys || 0;
                        document.getElementById('totalProducts').textContent = statsData.stats.total_products || 0;
                        document.getElementById('totalUsers').textContent = statsData.stats.total_users || 0;
                    }
                }
                const activationsResponse = await fetch(`${API_BASE_URL}/admin/activations?limit=5`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                if (activationsResponse.ok) {
                    const activationsData = await activationsResponse.json();
                    const activationsList = document.getElementById('recentActivations');
                    if (activationsData.success && activationsData.activations.length > 0) {
                        activationsList.innerHTML = activationsData.activations.map(activation => `
                            <tr>
                                <td>${activation.products && activation.products.name ? activation.products.name : 'غير معروف'}</td>
                                <td>${activation.device_id}</td>
                                <td>${activation.activated_at ? new Date(activation.activated_at).toLocaleDateString('ar-EG') : ''}</td>
                                <td><span class="badge badge-success">نشط</span></td>
                            </tr>
                        `).join('');
                    } else {
                        activationsList.innerHTML = '<tr><td colspan="4" class="text-center">لا توجد تفعيلات</td></tr>';
                    }
                }
            } catch (error) {
                console.error('Error loading dashboard data:', error);
            }
        }

        async function loadKeys() {
            try {
                const response = await fetch(`${API_BASE_URL}/admin/keys`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                if (response.ok) {
                    const data = await response.json();
                    const keysList = document.getElementById('keysList');
                    if (data.success && data.keys.length > 0) {
                        keysList.innerHTML = data.keys.map(key => `
                            <tr>
                                <td>${key.key_value}</td>
                                <td>${key.products && key.products.name ? key.products.name : 'غير معروف'} ${key.products && key.products.version ? `v${key.products.version}` : ''}</td>
                                <td>
                                    <span class="badge ${key.is_used ? 'badge-danger' : 'badge-success'}">
                                        ${key.is_used ? 'مستخدم' : 'غير مستخدم'}
                                    </span>
                                </td>
                                <td>${key.created_at ? new Date(key.created_at).toLocaleDateString('ar-EG') : ''}</td>
                                <td>${key.created_by || ''}</td>
                                <td>
                                    ${!key.is_used ? `
                                        <button class="btn btn-danger btn-sm" onclick="deleteKey('${key.key_value}')">
                                            <i class="fas fa-trash"></i> حذف
                                        </button>
                                    ` : ''}
                                </td>
                            </tr>
                        `).join('');
                    } else {
                        keysList.innerHTML = '<tr><td colspan="6" class="text-center">لا توجد مفاتيح</td></tr>';
                    }
                }
            } catch (error) {
                console.error('Error loading keys:', error);
            }
        }

        async function loadProducts() {
            try {
                const response = await fetch(`${API_BASE_URL}/admin/products`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                if (response.ok) {
                    const data = await response.json();
                    const productsList = document.getElementById('productsList');
                    if (data.success && data.products.length > 0) {
                        productsList.innerHTML = data.products.map(product => `
                            <tr>
                                <td>${product.name}</td>
                                <td>${product.version}</td>
                                <td>${product.price} ر.س</td>
                                <td>
                                    <span class="badge ${product.is_active ? 'badge-success' : 'badge-danger'}">
                                        ${product.is_active ? 'نشط' : 'غير نشط'}
                                    </span>
                                </td>
                                <td>
                                    <button class="btn btn-primary btn-sm" onclick="editProduct(${product.id})">
                                        <i class="fas fa-edit"></i> تعديل
                                    </button>
                                    <button class="btn btn-${product.is_active ? 'danger' : 'success'} btn-sm" 
                                            onclick="toggleProduct(${product.id}, ${!product.is_active})">
                                        <i class="fas fa-${product.is_active ? 'times' : 'check'}"></i> 
                                        ${product.is_active ? 'تعطيل' : 'تفعيل'}
                                    </button>
                                </td>
                            </tr>
                        `).join('');
                    } else {
                        productsList.innerHTML = '<tr><td colspan="5" class="text-center">لا توجد منتجات</td></tr>';
                    }
                }
            } catch (error) {
                console.error('Error loading products:', error);
            }
        }

        async function loadActivations() {
            try {
                const response = await fetch(`${API_BASE_URL}/admin/activations`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                if (response.ok) {
                    const data = await response.json();
                    const activationsList = document.getElementById('activationsList');
                    if (data.success && data.activations.length > 0) {
                        activationsList.innerHTML = data.activations.map(activation => `
                            <tr>
                                <td>${activation.users && activation.users.email ? activation.users.email : (activation.users && activation.users.device_id ? activation.users.device_id : 'مجهول')}</td>
                                <td>${activation.products && activation.products.name ? activation.products.name : 'غير معروف'} ${activation.products && activation.products.version ? `v${activation.products.version}` : ''}</td>
                                <td>${activation.device_id}</td>
                                <td>${activation.product_keys && activation.product_keys.key_value ? activation.product_keys.key_value : 'غير معروف'}</td>
                                <td>${activation.activated_at ? new Date(activation.activated_at).toLocaleDateString('ar-EG') : ''}</td>
                                <td><span class="badge badge-success">نشط</span></td>
                            </tr>
                        `).join('');
                    } else {
                        activationsList.innerHTML = '<tr><td colspan="6" class="text-center">لا توجد تفعيلات</td></tr>';
                    }
                }
            } catch (error) {
                console.error('Error loading activations:', error);
            }
        }

        // خيارات المنتجات للقوائم المنسدلة
        async function loadProductOptions() {
            try {
                const response = await fetch(`${API_BASE_URL}/products`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                if (response.ok) {
                    const data = await response.json();
                    const productSelect = document.getElementById('productSelect');
                    const reportProduct = document.getElementById('reportProduct');
                    // حذف الخيارات السابقة (الخيار الافتراضي يبقى)
                    while (productSelect && productSelect.options && productSelect.options.length > 1)
                        productSelect.remove(1);
                    while (reportProduct && reportProduct.options && reportProduct.options.length > 1)
                        reportProduct.remove(1);
                    if (data.success && data.products.length > 0) {
                        data.products.forEach(product => {
                            if (product.is_active) {
                                const opt1 = document.createElement('option');
                                opt1.value = product.id;
                                opt1.textContent = `${product.name} - الإصدار ${product.version}`;
                                if (productSelect) productSelect.appendChild(opt1);
                                const opt2 = document.createElement('option');
                                opt2.value = product.id;
                                opt2.textContent = `${product.name} - الإصدار ${product.version}`;
                                if (reportProduct) reportProduct.appendChild(opt2);
                            }
                        });
                    }
                }
            } catch (error) {
                console.error('Error loading product options:', error);
            }
        }

        // إضافة مفتاح جديد
        if (document.getElementById('addKeyForm')) {
        document.getElementById('addKeyForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const productId = document.getElementById('productSelect').value;
            const keyCount = document.getElementById('keyCount').value;
            const notes = document.getElementById('keyNotes').value;
            if (!productId) {
                showMessage(document.getElementById('addKeyMessage'), 'يرجى اختيار منتج', 'error');
                return;
            }
            try {
                const response = await fetch(`${API_BASE_URL}/admin/keys`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        product_id: productId,
                        notes: notes,
                        count: parseInt(keyCount)
                    })
                });
                const data = await response.json();
                const addKeyMessage = document.getElementById('addKeyMessage');
                if (data.success) {
                    showMessage(addKeyMessage, data.message, 'success');
                    document.getElementById('generatedKeys').classList.remove('hidden');
                    document.getElementById('keysOutput').value = data.keys.map(k => k.key_value).join('\n');
                    document.getElementById('addKeyForm').reset();
                } else {
                    showMessage(addKeyMessage, data.message, 'error');
                }
            } catch (error) {
                const addKeyMessage = document.getElementById('addKeyMessage');
                showMessage(addKeyMessage, 'خطأ في الاتصال بالخادم', 'error');
                console.error('Error adding key:', error);
            }
        });
        }

        // إضافة منتج جديد
        if (document.getElementById('addProductForm')) {
        document.getElementById('addProductForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('productName').value;
            const version = document.getElementById('productVersion').value;
            const price = document.getElementById('productPrice').value;
            const description = document.getElementById('productDescription').value;
            const is_active = document.getElementById('productStatus').value === 'true';
            try {
                const response = await fetch(`${API_BASE_URL}/admin/products`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        name,
                        version,
                        price: parseFloat(price) || 0,
                        description,
                        is_active
                    })
                });
                const data = await response.json();
                const addProductMessage = document.getElementById('addProductMessage');
                if (data.success) {
                    showMessage(addProductMessage, 'تم إضافة المنتج بنجاح', 'success');
                    document.getElementById('addProductForm').reset();
                    loadProducts();
                    loadProductOptions();
                } else {
                    showMessage(addProductMessage, data.message, 'error');
                }
            } catch (error) {
                const addProductMessage = document.getElementById('addProductMessage');
                showMessage(addProductMessage, 'خطأ في الاتصال بالخادم', 'error');
                console.error('Error adding product:', error);
            }
        });
        }

        // نسخ المفاتيح (Clipboard API متوافق مع معظم المتصفحات الحديثة)
        if (document.getElementById('copyKeysBtn')) {
        document.getElementById('copyKeysBtn').addEventListener('click', () => {
            const keysOutput = document.getElementById('keysOutput');
            if (navigator.clipboard) {
                navigator.clipboard.writeText(keysOutput.value)
                    .then(() => alert('تم نسخ المفاتيح إلى الحافظة'))
                    .catch(() => alert('حدث خطأ أثناء نسخ المفاتيح'));
            } else {
                keysOutput.select();
                document.execCommand('copy');
                alert('تم نسخ المفاتيح إلى الحافظة');
            }
        });
        }

        // حذف مفتاح
        window.deleteKey = async function(keyValue) {
            if (!confirm('هل أنت متأكد من رغبتك في حذف هذا المفتاح؟')) return;
            try {
                const response = await fetch(`${API_BASE_URL}/admin/keys/${keyValue}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const data = await response.json();
                if (data.success) {
                    alert('تم حذف المفتاح بنجاح');
                    loadKeys();
                } else {
                    alert('فشل في حذف المفتاح: ' + data.message);
                }
            } catch (error) {
                console.error('Error deleting key:', error);
                alert('خطأ في الاتصال بالخادم');
            }
        }

        // تعديل منتج
        window.editProduct = async function(productId) {
            try {
                const response = await fetch(`${API_BASE_URL}/admin/products`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                if (response.ok) {
                    const data = await response.json();
                    const product = data.products.find(p => p.id === productId);
                    if (product) {
                        document.getElementById('editProductId').value = product.id;
                        document.getElementById('editProductName').value = product.name;
                        document.getElementById('editProductVersion').value = product.version;
                        document.getElementById('editProductPrice').value = product.price;
                        document.getElementById('editProductDescription').value = product.description || '';
                        document.getElementById('editProductStatus').value = product.is_active ? "true" : "false";
                        document.getElementById('editProductModal').classList.remove('hidden');
                    }
                }
            } catch (error) {
                console.error('Error loading product for edit:', error);
            }
        }

        // إغلاق المودال بالنقر على زر الإغلاق أو خارج المودال
        if (document.querySelector('.close')) {
        document.querySelector('.close').addEventListener('click', () => {
            document.getElementById('editProductModal').classList.add('hidden');
        });
        }
        document.getElementById('editProductModal').addEventListener('click', function(e){
            if (e.target === this) this.classList.add('hidden');
        });

        // حفظ تعديل المنتج
        if (document.getElementById('editProductForm')) {
        document.getElementById('editProductForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const productId = document.getElementById('editProductId').value;
            const name = document.getElementById('editProductName').value;
            const version = document.getElementById('editProductVersion').value;
            const price = document.getElementById('editProductPrice').value;
            const description = document.getElementById('editProductDescription').value;
            const is_active = document.getElementById('editProductStatus').value === 'true';
            try {
                const response = await fetch(`${API_BASE_URL}/admin/products/${productId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        name,
                        version,
                        price: parseFloat(price) || 0,
                        description,
                        is_active
                    })
                });
                const data = await response.json();
                const editProductMessage = document.getElementById('editProductMessage');
                if (data.success) {
                    showMessage(editProductMessage, 'تم تحديث المنتج بنجاح', 'success');
                    loadProducts();
                    loadProductOptions();
                    setTimeout(() => {
                        document.getElementById('editProductModal').classList.add('hidden');
                    }, 2000);
                } else {
                    showMessage(editProductMessage, data.message, 'error');
                }
            } catch (error) {
                const editProductMessage = document.getElementById('editProductMessage');
                showMessage(editProductMessage, 'خطأ في الاتصال بالخادم', 'error');
                console.error('Error updating product:', error);
            }
        });
        }

        // تفعيل/تعطيل منتج
        window.toggleProduct = async function(productId, isActive) {
            try {
                const response = await fetch(`${API_BASE_URL}/admin/products/${productId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ is_active: isActive })
                });
                const data = await response.json();
                if (data.success) {
                    alert(`تم ${isActive ? 'تفعيل' : 'تعطيل'} المنتج بنجاح`);
                    loadProducts();
                    loadProductOptions();
                } else {
                    alert('فشل في تعديل حالة المنتج: ' + data.message);
                }
            } catch (error) {
                console.error('Error toggling product:', error);
                alert('خطأ في الاتصال بالخادم');
            }
        }

        // عرض الرسائل
        function showMessage(element, message, type) {
            element.innerHTML = `
                <div class="alert alert-${type}">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
                    ${message}
                </div>
            `;
            setTimeout(() => { element.innerHTML = ''; }, 5000);
        }

        // التحقق من وجود توكن محفوظ عند تحميل الصفحة
        window.addEventListener('DOMContentLoaded', () => {
            const savedToken = localStorage.getItem('adminToken');
            const savedAdmin = localStorage.getItem('adminData');
            if (savedToken && savedAdmin) {
                authToken = savedToken;
                currentAdmin = JSON.parse(savedAdmin);
                adminName.textContent = currentAdmin.name || currentAdmin.email;
                loginPage.classList.add('hidden');
                dashboardPage.classList.remove('hidden');
                loadDashboardData();
                loadProductOptions();
            }
        });
    </script>
</body>
</html>
